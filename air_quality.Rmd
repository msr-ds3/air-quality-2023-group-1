---
title: "air quality"
output: html_document
date: "2023-06-21"
---

```{r setup, include=FALSE}
library(tidyverse)
library(scales)
library(modelr)
library(lubridate)

theme_set(theme_bw())
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-data}
city <- read_csv(gzfile('data/city_day_agg_cleaned.csv.gz'))
country <- read_csv(gzfile('data/country_day_agg_cleaned.csv.gz'))
lockdown_USA <- read_csv('data/lockdown_dates.csv') %>% filter(countryCode == 'USA')
lockdown_CHE <- read_csv('data/lockdown_dates.csv') %>% filter(countryCode == 'CHE')
longlat <- read_csv('data/openaq_cities.csv')

```



```{r NO2}
city_no2 <- city %>% 
  filter(parameter == 'no2') %>%
  mutate(year = ifelse(date > '2019-12-31', "2020", "before 2020")) %>% 
  group_by(city_id, year) %>%
  summarize(avg = mean(mean, na.rm = TRUE)) %>% 
  group_by(year) %>% 
  mutate(avg_by_year = median(avg))
  
freq_no2 <- table(city_no2$city_id)
city_no2 <- city_no2[city_no2$city_id %in% names(freq_no2)[freq_no2 == 2], ]


city_no2 %>%
  ggplot(aes(x = avg, color = year, fill = year)) +
  geom_density(color = 'black', alpha = 0.5, position = "identity")+
  geom_vline(aes(xintercept = avg_by_year, color = year)) +
  # scale_x_log10()+
  labs(title = "City - NO2",
       x = "NO2",
       y = "Density")

## MAP

no2_map <- city %>%
  filter(parameter == 'no2') %>% 
  filter((('2017-01-01' <= date) & (date <= '2017-05-31')) | (('2018-01-01' <= date) & (date <= '2018-05-31')) | (('2019-01-01' <= date) & (date <= '2019-05-31')) | (('2020-01-01' <= date) & (date <= '2020-05-31'))) %>% 
  mutate(year = ifelse(date > '2019-12-31', "2020", "before 2020")) %>% 
  group_by(city_id, year) %>%
  summarize(avg = mean(mean, na.rm = TRUE))

freq_no2 <- table(no2_map$city_id)
no2_map <- no2_map[no2_map$city_id %in% names(freq_no2)[freq_no2 == 2], ]

no2_map <- left_join(no2_map, longlat, by = "city_id")




```


```{r O3}
city_o3 <- city %>% 
  filter(parameter == 'o3') %>%
  mutate(year = ifelse(date > '2019-12-31', "2020", "before 2020")) %>% 
  group_by(city_id, year) %>%
  summarize(avg = mean(mean, na.rm = TRUE)) %>% 
  group_by(year) %>% 
  mutate(avg_by_year = median(avg))
  
freq_o3 <- table(city_o3$city_id)
city_o3 <- city_o3[city_o3$city_id %in% names(freq_o3)[freq_o3 == 2], ]


city_o3 %>%
  ggplot(aes(x = avg, color = year, fill = year)) +
  geom_density(color = 'black', alpha = 0.5, position = "identity")+
  geom_vline(aes(xintercept = avg_by_year, color = year)) +
  # scale_x_log10()+
  labs(title = "City - O3",
       x = "O3",
       y = "Density")
```


```{r PM25}
city_pm <- city %>% 
  filter(parameter == 'pm25') %>%
  mutate(year = ifelse(date > '2019-12-31', "2020", "before 2020")) %>% 
  group_by(city_id, year) %>%
  summarize(avg = mean(mean, na.rm = TRUE)) %>% 
  group_by(year) %>% 
  mutate(avg_by_year = median(avg))
  
freq_pm <- table(city_pm$city_id)
city_pm <- city_pm[city_pm$city_id %in% names(freq_pm)[freq_pm == 2], ]
  

city_pm %>%
  ggplot(aes(x = avg, color = year, fill = year)) +
  geom_density(color = 'black', alpha = 0.5, position = "identity")+
  geom_vline(aes(xintercept = avg_by_year, color = year)) +
  # scale_x_log10()+
  labs(title = "City - PM2.5",
       x = "PM2.5",
       y = "Density")

```

```{r PM25 - country}
# country_pm <- country %>% 
#   filter(parameter == 'pm25') %>%
#   mutate(year = ifelse(date > '2019-12-31', "2020", "before 2020")) %>% 
#   group_by(countryCode, year) %>%
#   summarize(avg = mean(mean, na.rm = TRUE))
#   
# freq_pm_country <- table(country_pm$countryCode)
# country_pm <- country_pm[country_pm$countryCode %in% names(freq_pm_country)[freq_pm_country == 2], ]
# 
# avg_values_2020 <- subset(country_pm, year == '2020')$avg
# avg_values_before_2020 <- subset(country_pm, year == 'before 2020')$avg
# 
# median(avg_values_2020)
# median(avg_values_before_2020)
# 
# country_pm %>%
#   ggplot(aes(x = avg, color = year, fill = year)) +
#   geom_density(color = 'black', alpha = 0.5, position = "identity")+
#   geom_vline(aes(xintercept = median(avg_values_2020), color = "cadetblue2")) +
#   geom_vline(aes(xintercept = median(avg_values_before_2020), color = "coral1")) +
#   # scale_x_log10()+
#   labs(title = "Country - PM2.5",
#        x = "PM2.5",
#        y = "Density")
```

```{r}

```

